<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Roue des Gages ‚Äî La Kaz √† F√™te !</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="style.css">
<link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
<style>
  :root{
    --tropics1:#FF6F61; --tropics2:#FFD166; --tropics3:#06D6A0; --tropics4:#118AB2;
    --tropics5:#EF476F; --tropics6:#83D483; --tropics7:#F4A261; --tropics8:#9B5DE5;
  }
  .wrap{max-width:980px;margin:0 auto;padding:1rem;text-align:center}
  h1{font-family:'Pacifico',cursive;color:#f72585;margin:0.5rem 0 0.25rem;text-shadow:1px 1px 4px rgba(0,0,0,.12)}
  .sub{opacity:.9;margin-bottom:.75rem}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start}
  @media(max-width:900px){ .grid{grid-template-columns:1fr} }

  /* Canvas + pointe */
  .stage{position:relative;display:flex;flex-direction:column;align-items:center;gap:12px}
  #wheel{width:100%;max-width:420px;aspect-ratio:1;border-radius:50%;background:rgba(255,255,255,.2);box-shadow:0 8px 20px rgba(0,0,0,.15)}
  .pointer{
    position:absolute;top:-8px;left:50%;transform:translateX(-50%);
    width:0;height:0;border-left:14px solid transparent;border-right:14px solid transparent;border-bottom:24px solid #000;border-radius:3px;
    filter:drop-shadow(0 3px 6px rgba(0,0,0,.3));
  }

  .controls{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
  .btn{background:#5a189a;color:#fff;border:none;border-radius:8px;padding:.55rem .9rem;font-weight:800;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .ghost{background:transparent;border:2px solid #5a189a;color:#5a189a}
  .danger{background:#E74C3C}
  label{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:4px}

  /* Panneau gages */
  .card{background:rgba(255,255,255,.18);box-shadow:0 6px 14px rgba(0,0,0,.12);border-radius:14px;padding:12px;text-align:left}
  .card h3{margin:.25rem 0 .5rem;color:#3a0842}
  .row{display:flex;gap:8px;align-items:center}
  .row input{flex:1;padding:.55rem .7rem;border-radius:8px;border:1px solid rgba(0,0,0,.15);font-weight:600}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  .chip{display:flex;align-items:center;gap:6px;background:#fff;color:#3a0842;border-radius:999px;padding:.3rem .6rem;box-shadow:0 2px 6px rgba(0,0,0,.12)}
  .chip.used{opacity:.55}
  .chip button{background:transparent;border:none;color:#E74C3C;cursor:pointer;font-weight:900}
  textarea{width:100%;min-height:110px;padding:.6rem;border-radius:10px;border:1px solid rgba(0,0,0,.15);resize:vertical;font-weight:600}

  /* Modale r√©sultat */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:999}
  .modal.show{display:flex}
  .modal .box{max-width:560px;margin:20px;background:#fff;border-radius:16px;padding:18px;text-align:center}
  .result{font-size:1.4rem;font-weight:900;color:#5a189a;margin:.4rem 0 1rem}
</style>
</head>
<body>

<a href="index.html" class="back-btn">‚Üê Accueil</a>

<div class="wrap">
  <h1>Roue des Gages</h1>
  <div class="sub">Ajoute tes gages, tourne la roue et‚Ä¶ bonne chance üòàüå¥</div>

  <div class="grid">
    <!-- Zone roue -->
    <section class="card">
      <div class="stage">
        <div class="pointer"></div>
        <canvas id="wheel" width="600" height="600" aria-label="Roue des gages"></canvas>
        <div class="controls">
          <button id="spinBtn" class="btn">üé° Tourner</button>
          <button id="shuffleBtn" class="btn ghost" title="M√©langer l'ordre">üîÄ M√©langer</button>
          <button id="resetUsedBtn" class="btn ghost" title="R√©initialiser les gages d√©j√† sortis">‚ôªÔ∏è R√©initialiser sorties</button>
          <button id="clearAllBtn" class="btn danger" title="Supprimer tous les gages">üóëÔ∏è Vider</button>
        </div>
        <label><input type="checkbox" id="noRepeat"> √âviter de retomber sur un gage d√©j√† sorti</label>
      </div>
    </section>

    <!-- Zone configuration gages -->
    <section class="card">
      <h3>Gages</h3>
      <div class="row">
        <input id="newItem" type="text" placeholder="Ex: Danse du robot pendant 30s">
        <button id="addBtn" class="btn">+ Ajouter</button>
      </div>
      <div class="chips" id="chips"></div>

      <h3 style="margin-top:12px;">Importer (un par ligne)</h3>
      <textarea id="bulk" placeholder="Shot d'eau de coco
Chanter un zouk
Faire 10 pompes
Parler cr√©ole pendant 1 minute"></textarea>
      <div class="controls" style="justify-content:flex-start">
        <button id="bulkAddBtn" class="btn">Importer</button>
        <button id="exportBtn" class="btn ghost">Exporter</button>
      </div>
    </section>
  </div>
</div>

<!-- Modale r√©sultat -->
<div id="modal" class="modal" role="dialog" aria-modal="true">
  <div class="box">
    <div style="font-size:2rem">üéâ</div>
    <div>Le gage tir√© est :</div>
    <div id="result" class="result">‚Äî</div>
    <div class="controls" style="justify-content:center">
      <button id="againBtn" class="btn">Rejouer</button>
      <button id="closeModalBtn" class="btn ghost">Fermer</button>
    </div>
  </div>
</div>

<!-- (Optionnel) confettis -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

<script>
/* ========= √âTAT & PERSISTENCE ========= */
const LS_ITEMS = 'wheel_items';
const LS_USED  = 'wheel_used';

let items = JSON.parse(localStorage.getItem(LS_ITEMS) || '[]'); // [{text, used:false}]
let usedMap = JSON.parse(localStorage.getItem(LS_USED)  || '{}'); // {text:true}
if (!Array.isArray(items)) items = [];

if (items.length === 0){
  items = [
    { text:'Shot eau de coco', used:false },
    { text:'Danse 30s', used:false },
    { text:'Compliment √† la personne de ton choix', used:false },
    { text:'Chanter un zouk', used:false },
    { text:'Faire 10 pompes', used:false },
    { text:'Raconter une blague', used:false },
    { text:'Parler cr√©ole 1 min', used:false },
    { text:'Selfie avec 3 personnes', used:false },
  ];
  save();
}

/* ========= DOM ========= */
const canvas = document.getElementById('wheel');
const ctx = canvas.getContext('2d');
const spinBtn = document.getElementById('spinBtn');
const shuffleBtn = document.getElementById('shuffleBtn');
const resetUsedBtn = document.getElementById('resetUsedBtn');
const clearAllBtn = document.getElementById('clearAllBtn');
const noRepeat = document.getElementById('noRepeat');

const chips = document.getElementById('chips');
const newItem = document.getElementById('newItem');
const addBtn = document.getElementById('addBtn');
const bulk = document.getElementById('bulk');
const bulkAddBtn = document.getElementById('bulkAddBtn');
const exportBtn = document.getElementById('exportBtn');

const modal = document.getElementById('modal');
const resultEl = document.getElementById('result');
const againBtn = document.getElementById('againBtn');
const closeModalBtn = document.getElementById('closeModalBtn');

/* ========= UTILS ========= */
function save(){
  localStorage.setItem(LS_ITEMS, JSON.stringify(items));
  localStorage.setItem(LS_USED, JSON.stringify(usedMap));
}
function rand(min,max){ return Math.random()*(max-min)+min; }
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
}

/* ========= RENDU LISTE ========= */
function renderChips(){
  chips.innerHTML = '';
  items.forEach((it, idx)=>{
    const div = document.createElement('div');
    div.className = 'chip' + (usedMap[it.text] ? ' used' : '');
    div.innerHTML = `
      <span>${it.text}</span>
      <button title="Supprimer" aria-label="Supprimer">√ó</button>
    `;
    div.querySelector('button').onclick = ()=>{
      items.splice(idx,1);
      delete usedMap[it.text];
      save();
      drawWheel();
      renderChips();
    };
    chips.appendChild(div);
  });
}

/* ========= ROUE ========= */
const colors = ['#FF6F61','#FFD166','#06D6A0','#118AB2','#EF476F','#83D483','#F4A261','#9B5DE5'];

let angle = 0;        // angle courant en degr√©s
let spinning = false;

function drawWheel(){
  const n = items.length || 1;
  const cx = canvas.width/2, cy = canvas.height/2, r = Math.min(cx,cy)-8;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const slice = 360/n;
  // D√©cale de -90¬∞ pour que la "pointe" vise le haut
  let start = -90 + angle;

  for(let i=0;i<n;i++){
    const a1 = (start + i*slice) * Math.PI/180;
    const a2 = (start + (i+1)*slice) * Math.PI/180;

    // secteur
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,a1,a2);
    ctx.closePath();
    ctx.fillStyle = colors[i % colors.length];
    ctx.fill();

    // texte
    ctx.save();
    ctx.translate(cx,cy);
    const mid = (a1+a2)/2;
    ctx.rotate(mid);
    ctx.textAlign = 'right';
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 18px sans-serif';
    const label = items[i]?.text ?? '';
    wrapText(ctx, label, r-16, 20);
    ctx.restore();
  }

  // cercle centre
  ctx.beginPath();
  ctx.arc(cx,cy,42,0,Math.PI*2);
  ctx.fillStyle = 'rgba(255,255,255,.9)';
  ctx.fill();
  ctx.fillStyle = '#5a189a';
  ctx.font = 'bold 14px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('La Kaz', cx, cy-2);
  ctx.fillText('√† F√™te', cx, cy+14);
}

function wrapText(ctx, text, x, maxWidth){
  const words = String(text).split(' ');
  let line = '';
  const lines = [];
  words.forEach(w=>{
    const test = line ? line+' '+w : w;
    if (ctx.measureText(test).width > maxWidth) {
      if (line) lines.push(line);
      line = w;
    } else {
      line = test;
    }
  });
  if(line) lines.push(line);
  const offset = (lines.length-1)*10/2;
  lines.forEach((l, i)=>{
    ctx.fillText(l, x, i*20 - offset);
  });
}

/* ========= SPIN ========= */
function spin(){
  if (spinning || items.length===0) return;
  spinning = true;
  spinBtn.disabled = true;

  const n = items.length;
  const slice = 360/n;

  // cible al√©atoire (plusieurs tours + angle final)
  const extraTurns = rand(5,8); // tours complets
  const finalAngle = rand(0, 360);
  const target = angle + extraTurns*360 + finalAngle;

  const startTime = performance.now();
  const duration = 3800; // ms

  function easeOut(t){ return 1 - Math.pow(1-t, 3); }

  function animate(now){
    const t = Math.min(1, (now - startTime)/duration);
    const eased = easeOut(t);
    angle = lerp(angle, target, eased);
    drawWheel();

    if (t < 1) {
      requestAnimationFrame(animate);
    } else {
      angle = target % 360;
      onSpinEnd();
    }
  }
  requestAnimationFrame(animate);

  function lerp(a,b,t){ return a + (b-a)*t; }
}

function onSpinEnd(){
  const n = items.length;
  const slice = 360/n;
  // avec d√©calage -90¬∞, la pointe regarde 0¬∞
  // on cherche l'index dont le secteur couvre l'angle 0
  const norm = (angle % 360 + 360) % 360;          // 0..359
  const rawIndex = Math.floor(((360 - norm) % 360) / slice);
  const idx = (rawIndex + n) % n;

  let chosen = items[idx];

  // anti-r√©p√©tition: si d√©j√† utilis√©, on cherche le prochain non utilis√©
  if (noRepeat.checked && chosen && usedMap[chosen.text]) {
    let found = -1;
    for (let k=0;k<n;k++){
      const j = (idx + k) % n;
      if (!usedMap[items[j].text]) { found = j; break; }
    }
    if (found !== -1) {
      // aligner visuellement ? On laisse tel quel mais on marque le found.
      chosen = items[found];
    }
  }

  if (chosen){
    usedMap[chosen.text] = true;
    save();
    renderChips();
    showResult(chosen.text);
    try { confetti({ particleCount: 90, spread: 70, origin: { y: .6 } }); } catch(e){}
  }

  spinning = false;
  spinBtn.disabled = false;
}

function showResult(text){
  resultEl.textContent = text;
  modal.classList.add('show');
}

/* ========= EVENTS ========= */
spinBtn.onclick = spin;
shuffleBtn.onclick = ()=>{ shuffle(items); save(); drawWheel(); renderChips(); };
resetUsedBtn.onclick = ()=>{ usedMap = {}; save(); renderChips(); };
clearAllBtn.onclick = ()=>{
  if (!confirm('Supprimer tous les gages ?')) return;
  items = []; usedMap = {}; save(); drawWheel(); renderChips();
};

addBtn.onclick = ()=>{
  const t = (newItem.value || '').trim();
  if (!t) return;
  items.push({text:t, used:false});
  newItem.value = '';
  save();
  drawWheel();
  renderChips();
};
newItem.addEventListener('keydown', e=>{
  if (e.key==='Enter') addBtn.click();
});

bulkAddBtn.onclick = ()=>{
  const lines = (bulk.value || '').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  if (!lines.length) return;
  lines.forEach(t=> items.push({text:t, used:false}));
  bulk.value = '';
  save();
  drawWheel();
  renderChips();
};

exportBtn.onclick = ()=>{
  const txt = items.map(it=>it.text).join('\n');
  navigator.clipboard.writeText(txt).then(()=> {
    exportBtn.textContent = 'Copi√© ‚úÖ';
    setTimeout(()=> exportBtn.textContent='Exporter', 1200);
  });
};

againBtn.onclick = ()=>{ modal.classList.remove('show'); spin(); };
closeModalBtn.onclick = ()=>{ modal.classList.remove('show'); };
modal.addEventListener('click', e=>{ if (e.target===modal) modal.classList.remove('show'); });
document.addEventListener('keydown', e=>{
  if (e.key==='Escape') modal.classList.remove('show');
});

/* ========= INIT ========= */
renderChips();
drawWheel();
</script>
</body>
</html>
