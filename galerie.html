<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Librairie de Photos - La Kaz √† F√™te !</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
<style>
  body { margin:0; font-family:'Pacifico',cursive; background:#FAF9F6; color:#333; text-align:center; padding:1rem; }
  h1 { margin-bottom:1rem; font-size:2rem; color:#FFB347; }
  .upload-section { margin-bottom:1rem; }
  input[type="file"] { margin:0.5rem 0; }
  button {
    padding:0.5rem 1rem; border:none; background:#6F42C1; color:#fff; border-radius:5px; cursor:pointer;
    font-weight:600; transition: transform .2s;
  }
  button:hover { transform: scale(1.05); }
  .hint { font-size:.9rem; color:#666; margin-top:.5rem; }
  #status { margin:.75rem auto; max-width:900px; font-size:.95rem; color:#6F42C1; }

  .gallery { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:16px; margin-top:1rem; }
  .gallery-item { background:#fff; padding:8px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.2); display:flex; flex-direction:column; align-items:center; }
  .gallery-item img { width:100%; height:200px; object-fit:cover; border-radius:6px; cursor:pointer; }
  
  /* Interaction */
  .actions { display:flex; gap:10px; align-items:center; margin-top:6px; }
  .like-btn { background:none; border:none; cursor:pointer; font-size:1.4rem; }
  .like-count { font-weight:bold; color:#E74C3C; }
  .delete-btn { margin-left:auto; padding:3px 6px; background:#E74C3C; color:white; border:none; border-radius:4px; cursor:pointer; }

  .comments { text-align:left; width:100%; max-height:100px; overflow-y:auto; margin-top:6px; font-size:.9rem; }
  .comments p { margin:2px 0; }
  .comment-input { display:flex; margin-top:6px; gap:4px; width:100%; }
  .comment-input input { flex:1; padding:5px; border-radius:4px; border:1px solid #ccc; }
  .comment-input button { padding:5px 8px; background:#FFD700; border:none; border-radius:4px; cursor:pointer; }

  .back-btn { display:block; margin:1rem auto; padding:.5rem 1rem; background:#000; color:#fff; text-decoration:none; border-radius:5px; width:120px; }

  /* Lightbox */
  #lightbox {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.9); display:none; justify-content:center; align-items:center; flex-direction:column;
    z-index:1000;
  }
  #lightbox img { max-width:90%; max-height:80%; border-radius:8px; box-shadow:0 0 20px #000; }
  .nav-btn { position:absolute; top:50%; transform:translateY(-50%); font-size:3rem; color:white; cursor:pointer; user-select:none; padding:0 15px; }
  .nav-left { left:10px; } .nav-right { right:10px; }
  .close-btn { position:absolute; top:15px; right:20px; font-size:2.5rem; color:white; cursor:pointer; }

  /* Popup pseudo */
  #nameModal {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center;
    z-index:2000;
  }
  #nameModalContent {
    background:#fff; padding:20px; border-radius:8px; text-align:center; box-shadow:0 2px 10px rgba(0,0,0,0.3);
  }
  #nameModalContent input { padding:8px; border-radius:4px; border:1px solid #ccc; width:80%; margin-top:10px; }
  #nameModalContent button { margin-top:10px; padding:8px 12px; background:#6F42C1; color:#fff; border:none; border-radius:5px; cursor:pointer; }
</style>
</head>
<body>

<h1>Librairie de Photos üå¥</h1>
<a href="index.html" class="back-btn">‚Üê Accueil</a>

<div class="upload-section">
  <input type="file" id="photoInput" accept="image/*" multiple />
  <div class="toolbar"><button id="uploadBtn" type="button">Ajouter</button></div>
  <div class="hint">Les photos sont compress√©es (max ~1280px) et stock√©es en base64 dans la Realtime Database.</div>
  <div id="status"></div>
</div>

<div class="gallery" id="gallery"></div>

<!-- Lightbox -->
<div id="lightbox">
  <span class="close-btn">&times;</span>
  <span class="nav-btn nav-left">&#10094;</span>
  <img src="" alt="Zoom">
  <span class="nav-btn nav-right">&#10095;</span>
</div>

<!-- Modal pseudo -->
<div id="nameModal">
  <div id="nameModalContent">
    <h2>Entre ton pr√©nom/pseudo üéâ</h2>
    <input type="text" id="usernameInput" placeholder="Ton pr√©nom..." />
    <button id="saveUsername">Valider</button>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBq5OSHZzq6mixYfDrlfJHg397VjO_Plyc",
    authDomain: "kazafete-627b7.firebaseapp.com",
    databaseURL: "https://kazafete-627b7-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "kazafete-627b7",
    storageBucket: "kazafete-627b7.appspot.com",
    messagingSenderId: "1009736388412",
    appId: "1:1009736388412:web:62f833aa444f0d30909839"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Gestion pseudo
  let username = localStorage.getItem("username");
  const nameModal = document.getElementById("nameModal");
  document.getElementById("saveUsername").onclick = () => {
    const val = document.getElementById("usernameInput").value.trim();
    if(val) {
      username = val;
      localStorage.setItem("username", val);
      nameModal.style.display = "none";
    }
  };
  if(username) nameModal.style.display = "none";

  const input   = document.getElementById('photoInput');
  const upload  = document.getElementById('uploadBtn');
  const gallery = document.getElementById('gallery');

  let photos=[], photoKeys=[], currentIndex=0;

  function compressImage(file, maxW=1280, maxH=1280, quality=0.8) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      const reader = new FileReader();
      reader.onload = e => { img.src = e.target.result; };
      reader.onerror = reject;
      img.onload = () => {
        const r = Math.min(maxW / img.width, maxH / img.height, 1);
        const w = Math.round(img.width * r), h = Math.round(img.height * r);
        const c = document.createElement('canvas');
        c.width = w; c.height = h;
        c.getContext('2d').drawImage(img, 0, 0, w, h);
        resolve(c.toDataURL('image/jpeg', quality));
      };
      img.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  function renderItem(key, data, index) {
    const url = data.dataUrl;
    const div = document.createElement('div');
    div.className = 'gallery-item';
    div.innerHTML = `
      <img src="${url}" data-index="${index}">
      <div class="actions">
        <button class="like-btn">‚ù§Ô∏è</button>
        <span class="like-count">0</span>
        <button class="delete-btn">Supprimer</button>
      </div>
      <div class="comments"></div>
      <div class="comment-input">
        <input type="text" placeholder="Ajouter un commentaire...">
        <button>Envoyer</button>
      </div>
    `;

    // Like logique
    const likeBtn = div.querySelector('.like-btn');
    const likeCount = div.querySelector('.like-count');
    db.ref('photos/'+key+'/likes').on('value', snap => {
      const val = snap.val() || {};
      likeCount.textContent = Object.keys(val).length;
      likeBtn.style.color = val[username] ? "red" : "black";
    });
    likeBtn.onclick = () => {
      const ref = db.ref('photos/'+key+'/likes/'+username);
      ref.once('value').then(snap => {
        if(snap.exists()) ref.remove(); else ref.set(true);
      });
    };

    // Commentaires
    const commentsEl = div.querySelector('.comments');
    db.ref('photos/'+key+'/comments').on('value', snap => {
      commentsEl.innerHTML="";
      const val = snap.val()||{};
      Object.values(val).slice(-3).forEach(c=>{
        const p=document.createElement('p');
        p.textContent = c.user+": "+c.text;
        commentsEl.appendChild(p);
      });
    });
    div.querySelector('.comment-input button').onclick = () => {
      const text = div.querySelector('.comment-input input').value.trim();
      if(!text) return;
      db.ref('photos/'+key+'/comments').push({user:username, text});
      div.querySelector('.comment-input input').value="";
    };

    // Supprimer
    div.querySelector('.delete-btn').onclick = () => {
      if(confirm("Supprimer cette photo pour tout le monde ?")) {
        db.ref('photos/'+key).remove();
      }
    };

    // Zoom Lightbox
    div.querySelector('img').onclick = () => { currentIndex=index; showImage(); };

    return div;
  }

  function showImage() {
    document.getElementById('lightbox').style.display='flex';
    document.querySelector('#lightbox img').src = photos[currentIndex];
  }
  document.querySelector('.close-btn').onclick = () => document.getElementById('lightbox').style.display='none';
  document.querySelector('.nav-left').onclick = () => { currentIndex=(currentIndex-1+photos.length)%photos.length; showImage(); };
  document.querySelector('.nav-right').onclick= () => { currentIndex=(currentIndex+1)%photos.length; showImage(); };

  // Charger photos
  db.ref('photos').orderByChild('createdAt').on('value', snap => {
    const val = snap.val();
    gallery.innerHTML=""; photos=[]; photoKeys=[];
    if(!val) return;
    Object.entries(val).sort((a,b)=>(b[1].createdAt||0)-(a[1].createdAt||0))
      .forEach(([key,data],i)=>{
        photos.push(data.dataUrl); photoKeys.push(key);
        gallery.appendChild(renderItem(key,data,i));
      });
  });

  upload.onclick = async () => {
    const files=Array.from(input.files||[]);
    for(const f of files){
      const dataUrl = await compressImage(f);
      await db.ref('photos').push({ dataUrl, name:f.name, createdAt:Date.now() });
    }
    input.value="";
  };
</script>

</body>
</html>
