<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Librairie de Photos - La Kaz √† F√™te !</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
<style>
  body { margin:0; font-family:'Pacifico',cursive; background:#FAF9F6; color:#333; text-align:center; padding:1rem; }
  h1 { margin-bottom:1rem; font-size:2rem; color:#FFB347; }
  .upload-section { margin-bottom:1rem; }
  input[type="file"] { margin:0.5rem 0; }
  button {
    padding:0.5rem 1rem; border:none; background:#6F42C1; color:#fff; border-radius:5px; cursor:pointer;
    font-weight:600; transition: transform .2s;
  }
  button:hover { transform: scale(1.05); }
  .hint { font-size:.9rem; color:#666; margin-top:.5rem; }
  #status { margin:.75rem auto; max-width:900px; font-size:.95rem; color:#6F42C1; }

  .gallery { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:12px; margin-top:1rem; }
  .gallery-item { background:#fff; padding:4px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.2); }
  .gallery-item img { width:100%; height:200px; object-fit:cover; border-radius:6px; }
  .btn-container { margin-top:4px; display:flex; gap:4px; }
  .download-btn, .delete-btn { flex:1; padding:.3rem .5rem; font-size:.85rem; border:none; border-radius:5px; cursor:pointer; font-weight:600; text-decoration:none; text-align:center; }
  .download-btn { background:#FFD700; color:#111; }
  .delete-btn { background:#E74C3C; color:#fff; }
  .back-btn { display:block; margin:1rem auto; padding:.5rem 1rem; background:#000; color:#fff; text-decoration:none; border-radius:5px; width:120px; }
  .toolbar { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-top:.5rem; }
</style>
</head>
<body>

<h1>Librairie de Photos üå¥</h1>
<a href="index.html" class="back-btn">‚Üê Accueil</a>

<div class="upload-section">
  <input type="file" id="photoInput" accept="image/*" multiple />
  <div class="toolbar">
    <button id="uploadBtn" type="button">Ajouter</button>
  </div>
  <div class="hint">Les photos sont compress√©es (max ~1280px) et stock√©es en base64 dans la Realtime Database.</div>
  <div id="status"></div>
</div>

<div class="gallery" id="gallery"></div>

<!-- ============== Firebase v8 (CDN) ============== -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
  // ========= Config RTDB uniquement =========
  const firebaseConfig = {
    apiKey: "AIzaSyBq5OSHZzq6mixYfDrlfJHg397VjO_Plyc",
    authDomain: "kazafete-627b7.firebaseapp.com",
    databaseURL: "https://kazafete-627b7-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "kazafete-627b7",
    storageBucket: "kazafete-627b7.appspot.com",
    messagingSenderId: "1009736388412",
    appId: "1:1009736388412:web:62f833aa444f0d30909839"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ========= Helpers / UI =========
  const input   = document.getElementById('photoInput');
  const upload  = document.getElementById('uploadBtn');
  const testBtn = document.getElementById('testBtn');
  const gallery = document.getElementById('gallery');
  const statusEl= document.getElementById('status');

  function log(msg, isError=false) {
    (isError ? console.error : console.log)(msg);
    statusEl.textContent = msg;
  }

  // Auto-fix si /photos == "null"
  db.ref('photos').once('value').then(snap => {
    if (typeof snap.val() === 'string') {
      log('Correction: /photos √©tait "null" (cha√Æne) ‚Üí remise √† null.');
      return db.ref('photos').set(null);
    }
  });

  // Compression image (canvas ‚Üí base64)
  function compressImage(file, maxW=1280, maxH=1280, quality=0.8) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      const reader = new FileReader();
      reader.onload = e => { img.src = e.target.result; };
      reader.onerror = reject;
      img.onload = () => {
        const r = Math.min(maxW / img.width, maxH / img.height, 1);
        const w = Math.round(img.width * r), h = Math.round(img.height * r);
        const c = document.createElement('canvas');
        c.width = w; c.height = h;
        c.getContext('2d').drawImage(img, 0, 0, w, h);
        resolve(c.toDataURL('image/jpeg', quality));
      };
      img.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  function renderItem(key, data) {
    const url  = data.dataUrl || data.url;
    const name = data.name || 'photo';
    const div  = document.createElement('div');
    div.className = 'gallery-item';
    div.dataset.key = key;
    div.innerHTML = `
      <img src="${url}" alt="${name}">
      <div class="btn-container">
        <a class="download-btn" href="${url}" download="${name.replace(/\.[^/.]+$/, '')}.jpg">T√©l√©charger</a>
        <button class="delete-btn">Supprimer</button>
      </div>
    `;
    div.querySelector('.delete-btn').onclick = async () => {
      if (!confirm('Supprimer cette photo pour tout le monde ?')) return;
      try { await db.ref('photos/'+key).remove(); log('Photo supprim√©e.'); }
      catch(e){ log('Erreur suppression : '+e.message, true); }
    };
    return div;
  }

  // Lecture temps r√©el
  db.ref('photos').orderByChild('createdAt').on('value', snap => {
    const val = snap.val();
    gallery.innerHTML = '';
    if (!val) { log('Aucune photo pour le moment.'); return; }
    const entries = Object.entries(val).sort((a,b)=>(b[1].createdAt||0)-(a[1].createdAt||0));
    for (const [key, data] of entries) gallery.appendChild(renderItem(key, data));
    log(`Photos charg√©es : ${entries.length}`);
  }, err => log('Erreur lecture DB : '+err.message, true));

  // Upload de fichiers s√©lectionn√©s
  upload.onclick = async () => {
    try {
      const files = Array.from(input.files || []);
      if (!files.length) { log('S√©lectionne au moins une photo.', true); return; }
      upload.disabled = true; log('Compression & envoi en cours‚Ä¶');
      for (const f of files) {
        const dataUrl = await compressImage(f, 1280, 1280, 0.8);
        await db.ref('photos').push({ dataUrl, name: f.name || 'photo', createdAt: Date.now() });
      }
      log('Upload termin√© ‚úÖ'); input.value = '';
    } catch(e) {
      log('Erreur upload : ' + e.message, true);
    } finally {
      upload.disabled = false;
    }
  };

  // Bouton de test : pousse une entr√©e factice dans /photos
  testBtn.onclick = async () => {
    try {
      const keyRef = await db.ref('photos').push({
        dataUrl: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="600" height="400"><rect width="100%" height="100%" fill="orange"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="32" fill="white">TEST OK</text></svg>',
        name: 'test.svg',
        createdAt: Date.now()
      });
      log('Entr√©e test cr√©√©e : ' + keyRef.key);
    } catch(e) {
      log('Erreur test push : ' + e.message, true);
    }
  };

  log('RTDB initialis√©e. Pr√™te ‚úÖ');
</script>

</body>
</html>
