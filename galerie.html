<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Librairie de Photos - La Kaz √† F√™te !</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
<style>
  body { margin:0; font-family:'Pacifico',cursive; background:#FAF9F6; color:#333; text-align:center; padding:1rem; }
  h1 { margin-bottom:1rem; font-size:2rem; color:#FFB347; }
  .upload-section { margin-bottom:1rem; }
  input[type="file"] { margin:0.5rem 0; }
  button {
    padding:0.5rem 1rem; border:none; background:#6F42C1; color:#fff; border-radius:5px; cursor:pointer;
    font-weight:600; transition: transform .2s;
  }
  button:hover { transform: scale(1.05); }
  .hint { font-size:.9rem; color:#666; margin-top:.5rem; }
  #status { margin:.75rem auto; max-width:900px; font-size:.95rem; color:#6F42C1; }

  .gallery { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:16px; margin-top:1rem; }
  .gallery-item { background:#fff; padding:8px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.2); text-align:left; }
  .gallery-item img { width:100%; height:200px; object-fit:cover; border-radius:6px; cursor:pointer; }
  .btn-container { margin-top:6px; display:flex; gap:6px; }
  .download-btn, .delete-btn { flex:1; padding:.3rem .5rem; font-size:.85rem; border:none; border-radius:5px; cursor:pointer; font-weight:600; text-decoration:none; text-align:center; }
  .download-btn { background:#FFD700; color:#111; }
  .delete-btn { background:#E74C3C; color:#fff; }

  /* Like & Commentaires */
  .like-section { display:flex; align-items:center; gap:8px; margin-top:6px; }
  .like-btn { background:none; border:none; cursor:pointer; font-size:1.3rem; }
  .like-btn.liked { color:red; }
  .comments { margin-top:8px; max-height:120px; overflow-y:auto; border-top:1px solid #eee; padding-top:4px; font-size:.9rem; }
  .comment { text-align:left; margin:2px 0; }
  .comment strong { color:#6F42C1; }
  .comment-input { display:flex; margin-top:4px; }
  .comment-input input { flex:1; padding:4px; border:1px solid #ccc; border-radius:4px; font-family:inherit; }
  .comment-input button { margin-left:4px; padding:4px 8px; font-size:.8rem; }

  .back-btn { display:block; margin:1rem auto; padding:.5rem 1rem; background:#000; color:#fff; text-decoration:none; border-radius:5px; width:120px; }
</style>
</head>
<body>

<h1>Librairie de Photos üå¥</h1>
<a href="index.html" class="back-btn">‚Üê Accueil</a>

<div class="upload-section">
  <input type="file" id="photoInput" accept="image/*" multiple />
  <button id="uploadBtn" type="button">Ajouter</button>
  <div class="hint">Les photos sont compress√©es (max ~1280px) et stock√©es en base64 dans la Realtime Database.</div>
  <div id="status"></div>
</div>

<div class="gallery" id="gallery"></div>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBq5OSHZzq6mixYfDrlfJHg397VjO_Plyc",
    authDomain: "kazafete-627b7.firebaseapp.com",
    databaseURL: "https://kazafete-627b7-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "kazafete-627b7",
    storageBucket: "kazafete-627b7.appspot.com",
    messagingSenderId: "1009736388412",
    appId: "1:1009736388412:web:62f833aa444f0d30909839"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const input = document.getElementById('photoInput');
  const uploadBtn = document.getElementById('uploadBtn');
  const gallery = document.getElementById('gallery');
  const statusEl = document.getElementById('status');

  function log(msg){ console.log(msg); statusEl.textContent=msg; }

  function compressImage(file, maxW=1280, maxH=1280, quality=0.8) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      const reader = new FileReader();
      reader.onload = e => { img.src = e.target.result; };
      reader.onerror = reject;
      img.onload = () => {
        const r = Math.min(maxW/img.width, maxH/img.height, 1);
        const w = img.width*r, h = img.height*r;
        const c = document.createElement('canvas');
        c.width = w; c.height = h;
        c.getContext('2d').drawImage(img,0,0,w,h);
        resolve(c.toDataURL('image/jpeg', quality));
      };
      img.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // Rendu d'une photo
  function renderItem(key, data) {
    const url = data.dataUrl;
    const likes = data.likes || 0;
    const div = document.createElement('div');
    div.className = 'gallery-item';
    div.innerHTML = `
      <img src="${url}" alt="photo">
      <div class="btn-container">
        <a href="${url}" download="photo.jpg" class="download-btn">T√©l√©charger</a>
        <button class="delete-btn">Supprimer</button>
      </div>
      <div class="like-section">
        <button class="like-btn ${data.liked ? 'liked':''}">‚ù§Ô∏è</button>
        <span class="like-count">${likes}</span>
      </div>
      <div class="comments"></div>
      <div class="comment-input">
        <input type="text" placeholder="√âcrire un commentaire...">
        <button>Envoyer</button>
      </div>
    `;

    // Supprimer
    div.querySelector('.delete-btn').onclick = () => {
      if(confirm('Supprimer cette photo ?'))
        db.ref('photos/'+key).remove();
    };

    // Like
    const likeBtn = div.querySelector('.like-btn');
    const likeCount = div.querySelector('.like-count');
    likeBtn.onclick = () => {
      const newLikes = (data.likes || 0) + (likeBtn.classList.contains('liked') ? -1 : 1);
      db.ref('photos/'+key).update({ likes:newLikes });
    };

    // Commentaires en direct
    const commentsDiv = div.querySelector('.comments');
    db.ref('photos/'+key+'/comments').on('value', snap => {
      commentsDiv.innerHTML='';
      const val = snap.val();
      if(val){
        Object.values(val).forEach(c=>{
          const p=document.createElement('div');
          p.className='comment';
          p.innerHTML=`<strong>${c.user||'Anonyme'}:</strong> ${c.text}`;
          commentsDiv.appendChild(p);
        });
      }
    });

    // Ajout commentaire
    const inputField = div.querySelector('.comment-input input');
    div.querySelector('.comment-input button').onclick = () => {
      if(!inputField.value.trim()) return;
      db.ref('photos/'+key+'/comments').push({ user:'Invit√©', text:inputField.value.trim(), ts:Date.now() });
      inputField.value='';
    };

    return div;
  }

  // √âcoute photos
  db.ref('photos').on('value', snap => {
    gallery.innerHTML='';
    const val=snap.val();
    if(!val){ log("Aucune photo"); return; }
    Object.entries(val).reverse().forEach(([key,data])=>{
      gallery.appendChild(renderItem(key,data));
    });
    log("Photos charg√©es");
  });

  // Upload
  uploadBtn.onclick = async () => {
    const files = Array.from(input.files||[]);
    if(!files.length){ alert("Choisis des photos"); return; }
    for(const f of files){
      const dataUrl = await compressImage(f);
      await db.ref('photos').push({ dataUrl, createdAt:Date.now(), likes:0 });
    }
    input.value='';
  };
</script>

</body>
</html>

