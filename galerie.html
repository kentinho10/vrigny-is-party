<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Librairie de Photos - La Kaz √† F√™te !</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
<style>
  body { margin:0; font-family:'Pacifico',cursive; background:#FAF9F6; color:#333; text-align:center; padding:1rem; }
  h1 { margin-bottom:1rem; font-size:2rem; color:#FFB347; }
  .upload-section { margin-bottom:1rem; }
  input[type="file"] { margin:0.5rem 0; }
  button {
    padding:0.4rem 0.8rem; border:none; background:#6F42C1; color:#fff; border-radius:5px; cursor:pointer;
    font-weight:600; transition: transform .2s;
  }
  button:hover { transform: scale(1.05); }
  .hint { font-size:.9rem; color:#666; margin-top:.5rem; }
  #status { margin:.75rem auto; max-width:900px; font-size:.95rem; color:#6F42C1; }

  .gallery { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:15px; margin-top:1rem; }
  .gallery-item { background:#fff; padding:8px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.18); text-align:left; }
  .gallery-item img { width:100%; height:220px; object-fit:cover; border-radius:8px; cursor:pointer; }
  .btn-container { margin-top:8px; display:flex; gap:8px; }
  .download-btn, .delete-btn { flex:1; padding:.35rem .6rem; font-size:.85rem; border:none; border-radius:6px; cursor:pointer; font-weight:600; text-align:center; }
  .download-btn { background:#FFD700; color:#111; text-decoration:none; }
  .delete-btn { background:#E74C3C; color:#fff; }

  .likes-comments { margin-top:10px; }
  .like-row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .like-btn { background:none; border:1px solid #eee; padding:.25rem .6rem; border-radius:999px; cursor:pointer; font-size:1rem; }
  .like-count { font-weight:700; }
  .likers { font-size:.85rem; color:#555; margin-top:4px; }
  .likers strong { color:#6F42C1; }

  .comments { margin-top:8px; max-height:160px; overflow-y:auto; font-size:.9rem; }
  .comment { margin:4px 0; padding:4px 6px; background:#f7f7f7; border-radius:6px; }
  .comment strong { color:#6F42C1; }
  .comment-input { width:70%; padding:6px; border:1px solid #ccc; border-radius:6px; }
  .comment-btn { padding:6px 10px; background:#6F42C1; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:.85rem; }

  .back-btn { display:block; margin:1rem auto; padding:.5rem 1rem; background:#000; color:#fff; text-decoration:none; border-radius:6px; width:130px; }
  .toolbar { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-top:.5rem; }

  /* Lightbox plein √©cran */
  #lightbox {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.9);
    display:none; justify-content:center; align-items:center;
    z-index:1000; flex-direction:column; color:#fff; padding:20px;
  }
  #lightbox img { max-width:92%; max-height:55%; border-radius:10px; box-shadow:0 0 20px #000; }
  .nav-btn { position:absolute; top:50%; transform:translateY(-50%); font-size:3rem; color:white; cursor:pointer; user-select:none; padding:0 15px; }
  .nav-btn:hover { color:#FFD700; }
  .nav-left { left:10px; } .nav-right { right:10px; }

  /* CROIX visible & cliquable (meilleure access sur mobile) */
  .close-btn {
    position:absolute; top:10px; right:10px;
    width:44px; height:44px; line-height:44px; text-align:center;
    border-radius:999px;
    background: rgba(0,0,0,0.6);
    box-shadow: 0 2px 8px rgba(0,0,0,.4);
    font-size:28px; font-weight:700; color:#fff; cursor:pointer;
  }
  .close-btn:active { transform: scale(0.96); }
  @media (max-width: 480px){
    .close-btn { top:8px; right:8px; }
  }

  #lightbox .likes-comments { width:92%; max-width:820px; margin-top:14px; text-align:left; }
  #lightbox .likers { color:#ddd; }
</style>
</head>
<body>

<h1>Librairie de Photos üå¥</h1>
<a href="index.html" class="back-btn">‚Üê Accueil</a>

<div class="upload-section">
  <input type="file" id="photoInput" accept="image/*" multiple />
  <div class="toolbar"><button id="uploadBtn" type="button">Ajouter</button></div>
  <div class="hint">Les photos sont compress√©es (~1280px) et stock√©es en base64 dans la Realtime Database.</div>
  <div id="status"></div>
</div>

<div class="gallery" id="gallery"></div>

<!-- Lightbox -->
<div id="lightbox">
  <span class="close-btn" title="Fermer">√ó</span>
  <span class="nav-btn nav-left" title="Pr√©c√©dente">&#10094;</span>
  <img src="" alt="Zoom">
  <span class="nav-btn nav-right" title="Suivante">&#10095;</span>

  <div class="likes-comments" id="lightboxDetails">
    <!-- rempli dynamiquement -->
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBq5OSHZzq6mixYfDrlfJHg397VjO_Plyc",
    authDomain: "kazafete-627b7.firebaseapp.com",
    databaseURL: "https://kazafete-627b7-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "kazafete-627b7",
    storageBucket: "kazafete-627b7.appspot.com",
    messagingSenderId: "1009736388412",
    appId: "1:1009736388412:web:62f833aa444f0d30909839"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let username = localStorage.getItem("username");
  if (!username) {
    username = prompt("Entre ton pr√©nom pour la galerie :");
    if (!username) username = "Invit√©";
    localStorage.setItem("username", username);
  }

  const input = document.getElementById('photoInput');
  const upload = document.getElementById('uploadBtn');
  const gallery = document.getElementById('gallery');
  const statusEl = document.getElementById('status');

  const lightbox = document.getElementById('lightbox');
  const lightboxImg = lightbox.querySelector('img');
  const lightboxDetails = document.getElementById('lightboxDetails');
  const closeBtn = lightbox.querySelector('.close-btn');
  const leftBtn = lightbox.querySelector('.nav-left');
  const rightBtn = lightbox.querySelector('.nav-right');

  let photos = [];
  let currentIndex = 0;

  function log(msg){ statusEl.textContent = msg; }

  // compresser image
  function compressImage(file,maxW=1280,maxH=1280,q=0.8){
    return new Promise((res,rej)=>{
      const img=new Image(),r=new FileReader();
      r.onload=e=>{img.src=e.target.result}; r.onerror=rej;
      img.onload=()=>{
        const scale=Math.min(maxW/img.width,maxH/img.height,1);
        const c=document.createElement("canvas");
        c.width=Math.round(img.width*scale); c.height=Math.round(img.height*scale);
        c.getContext("2d").drawImage(img,0,0,c.width,c.height);
        res(c.toDataURL("image/jpeg",q));
      };
      img.onerror=rej; r.readAsDataURL(file);
    });
  }

  // Afficher une photo (carte)
  function renderItem(key,data,index){
    const url=data.dataUrl, name=data.name||'photo';
    const div=document.createElement('div'); div.className='gallery-item';
    div.innerHTML=`
      <img src="${url}" data-index="${index}">
      <div class="btn-container">
        <a class="download-btn" href="${url}" download="${name}.jpg">T√©l√©charger</a>
        <button class="delete-btn">Supprimer</button>
      </div>
      <div class="likes-comments">
        <div class="like-row">
          <button class="like-btn">‚ù§Ô∏è <span class="like-count">0</span></button>
          <div class="likers"><strong>Aim√© par :</strong> <span class="likers-list">Personne‚Ä¶ encore üòâ</span></div>
        </div>
        <div class="comments"></div>
        <div style="display:flex; gap:6px; margin-top:6px;">
          <input type="text" class="comment-input" placeholder="Ajouter un commentaire...">
          <button class="comment-btn">Envoyer</button>
        </div>
      </div>
    `;

    // delete
    div.querySelector('.delete-btn').onclick=()=>{ if(confirm("Supprimer cette photo pour tout le monde ?")) db.ref("photos/"+key).remove(); };

    // likes (compteur + liste des pseudos)
    const likeBtn=div.querySelector('.like-btn');
    const likeCount=div.querySelector('.like-count');
    const likersListEl=div.querySelector('.likers-list');

    db.ref("photos/"+key+"/likes").on("value",s=>{
      const likes=s.val()||{};
      const names=Object.keys(likes);
      likeCount.textContent = names.length;
      likersListEl.textContent = names.length ? names.join(", ") : "Personne‚Ä¶ encore üòâ";
      likeBtn.style.color = likes[username] ? "red" : "black";
    });

    // cliquer = like (pas d'unlike ici)
    likeBtn.onclick=()=>{ db.ref("photos/"+key+"/likes/"+username).set(true); };

    // comments (liste + ajout)
    const comDiv=div.querySelector('.comments');
    db.ref("photos/"+key+"/comments").on("value",s=>{
      comDiv.innerHTML=""; const val=s.val()||{};
      Object.values(val).forEach(c=>{
        const el=document.createElement('div');
        el.className="comment";
        el.innerHTML = `<strong>${(c.user||"Invit√©")}:</strong> ${c.text||""}`;
        comDiv.appendChild(el);
      });
    });
    div.querySelector('.comment-btn').onclick=()=>{
      const inp=div.querySelector('.comment-input');
      const text=inp.value.trim();
      if(!text) return;
      db.ref("photos/"+key+"/comments").push({user:String(username),text:String(text)});
      inp.value="";
    };

    return div;
  }

  // lecture DB
  db.ref("photos").orderByChild("createdAt").on("value",snap=>{
    gallery.innerHTML=""; photos=[];
    const val=snap.val(); if(!val){ log("Aucune photo"); return; }
    const arr=Object.entries(val).sort((a,b)=>(b[1].createdAt||0)-(a[1].createdAt||0));
    arr.forEach(([k,d],i)=>{ photos.push({key:k,...d}); gallery.appendChild(renderItem(k,d,i)); });
  });

  // upload
  upload.onclick=async()=>{
    const files=Array.from(input.files||[]); if(!files.length){ log("Choisis une photo"); return; }
    for(const f of files){
      const dataUrl=await compressImage(f);
      await db.ref("photos").push({dataUrl,name:f.name,createdAt:Date.now()});
    }
    input.value=""; log("Upload termin√© ‚úÖ");
  };

  // lightbox
  gallery.onclick=(e)=>{ if(e.target.tagName==="IMG"){ currentIndex=parseInt(e.target.dataset.index); showImage(); } };

  function showImage(){
    const p=photos[currentIndex];
    lightboxImg.src=p.dataUrl; lightbox.style.display="flex";

    // Bloc d√©tails (likes + liste des pseudos + commentaires + input)
    lightboxDetails.innerHTML=`
      <div class="like-row">
        <button id="lbLike" class="like-btn">‚ù§Ô∏è</button>
        <span id="lbLikeCount" class="like-count">0</span>
        <div class="likers" id="lbLikers" style="margin-left:10px;"><strong>Aim√© par :</strong> <span>Aucun</span></div>
      </div>
      <div id="lbComments" class="comments" style="color:#111; background:#fff; border-radius:8px; padding:8px; margin-top:8px;"></div>
      <div style="display:flex; gap:6px; margin-top:8px;">
        <input type="text" id="lbInput" class="comment-input" placeholder="Ajouter un commentaire...">
        <button id="lbSend" class="comment-btn">Envoyer</button>
      </div>
    `;

    const likeBtn=document.getElementById("lbLike"),
          likeCount=document.getElementById("lbLikeCount"),
          lbLikers=document.getElementById("lbLikers").querySelector('span');

    // likes (compteur + liste pseudos)
    db.ref("photos/"+p.key+"/likes").on("value",s=>{
      const likes=s.val()||{};
      const names=Object.keys(likes);
      likeCount.textContent = names.length;
      lbLikers.textContent = names.length ? names.join(", ") : "Aucun";
      likeBtn.style.color = likes[username] ? "red" : "white";
    });
    likeBtn.onclick=()=>db.ref("photos/"+p.key+"/likes/"+username).set(true);

    // comments
    const comDiv=document.getElementById("lbComments");
    db.ref("photos/"+p.key+"/comments").on("value",s=>{
      comDiv.innerHTML=""; const val=s.val()||{};
      Object.values(val).forEach(c=>{
        const el=document.createElement('div');
        el.className="comment";
        el.innerHTML = `<strong>${(c.user||"Invit√©")}:</strong> ${c.text||""}`;
        comDiv.appendChild(el);
      });
    });
    document.getElementById("lbSend").onclick=()=>{
      const inp=document.getElementById("lbInput");
      const text=inp.value.trim();
      if(!text) return;
      db.ref("photos/"+p.key+"/comments").push({user:String(username),text:String(text)});
      inp.value="";
    };
  }

  // nav & close
  closeBtn.onclick=()=>lightbox.style.display="none";
  leftBtn.onclick=()=>{currentIndex=(currentIndex-1+photos.length)%photos.length;showImage();};
  rightBtn.onclick=()=>{currentIndex=(currentIndex+1)%photos.length;showImage();};

  // fermer si clic fond noir
  lightbox.addEventListener('click',(e)=>{ if(e.target===lightbox) lightbox.style.display="none"; });

  // swipe mobile
  let startX=0;
  lightbox.addEventListener('touchstart',e=>{ startX=e.touches[0].clientX; });
  lightbox.addEventListener('touchend',e=>{
    let endX=e.changedTouches[0].clientX;
    if(startX-endX>50) rightBtn.click();
    if(endX-startX>50) leftBtn.click();
  });
</script>
</body>
</html>
