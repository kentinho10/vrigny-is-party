<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Patate Chaude ‚Äì Tropical Fun</title>
  <meta name="description" content="Version simple & ludique de Hot Potato avec th√®me tropical (HTML/CSS/JS ‚Äì 1 fichier).">
  <style>
    :root{
      /* Palette tropicale */
      --bg:#0a1f22;           /* nuit lagon */
      --bg2:#072023;          /* d√©grad√© */
      --panel:#0f2e31;        /* carte */
      --panel2:#12383c;
      --text:#f5fff9;         /* ivoire doux */
      --muted:#bfe8dc;        /* menthe claire */
      --accent:#26d7ae;       /* vert lagon */
      --accent2:#ffcc66;      /* mangue */
      --accent3:#ff7f6e;      /* corail */
      --leaf:#35e39c;         /* palme */
      --radius:22px;
      --shadow:0 14px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 800px at 10% -10%, #0d2c2f 0%, var(--bg2) 55%, var(--bg) 100%),
        linear-gradient(135deg, rgba(38,215,174,.08), rgba(255,127,110,.06));
    }

    /* ‚Äî‚Äî‚Äî Header minimal ‚Äî‚Äî‚Äî */
    header{max-width:980px; margin:18px auto 10px; padding:0 14px; display:flex; align-items:end; justify-content:space-between; gap:12px}
    .title{display:flex; align-items:center; gap:10px}
    .title h1{margin:0; font-size:clamp(26px,4vw,42px); letter-spacing:.2px}
    .badge{font-size:12px; color:#063b2f; background:linear-gradient(135deg, var(--accent), var(--accent2)); padding:6px 10px; border-radius:999px; font-weight:800}
    .btn{--bg:linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); background:var(--bg); color:var(--text); border:1px solid rgba(255,255,255,.12); padding:10px 14px; border-radius:14px; cursor:pointer; font-weight:800; box-shadow:var(--shadow); transition:.15s transform ease, .15s opacity}
    .btn:hover{transform:translateY(-1px)} .btn:active{transform:translateY(0)}
    .btn.ghost{background:transparent; border:1px dashed rgba(255,255,255,.3)}
    .btn.acc{background:linear-gradient(135deg, var(--accent), var(--accent2)); color:#08322b; border:0}

    /* ‚Äî‚Äî‚Äî Layout : jeu en haut, config en bas ‚Äî‚Äî‚Äî */
    .container{max-width:980px; margin:0 auto; padding:0 14px 20px}

    .card{background:linear-gradient(135deg, var(--panel), var(--panel2)); border:1px solid rgba(255,255,255,.10); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden}
    .card .hd{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.10); color:var(--muted)}
    .card .bd{padding:14px}

    /* ‚Äî‚Äî‚Äî Zone de jeu ‚Äî‚Äî‚Äî */
    .arena{position:relative; width:100%; aspect-ratio:1/1; min-height:360px; display:grid; place-items:center; background:
      radial-gradient(420px 260px at 50% 30%, rgba(255,255,255,.05), rgba(255,255,255,0)),
      linear-gradient(180deg, rgba(38,215,174,.08), rgba(255,204,102,.08));
      border-radius:20px; border:1px solid rgba(255,255,255,.08);
    }
    .ring{position:relative; width:min(92%,560px); aspect-ratio:1/1; border-radius:999px; box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)}
    .player{position:absolute; width:74px; height:74px; border-radius:18px; display:grid; place-items:center; background:linear-gradient(135deg, rgba(255,255,255,.12), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.18); box-shadow:var(--shadow); transition:.12s transform ease, .2s outline ease}
    .player span{font-weight:900; font-size:14px; padding:0 8px; text-align:center}
    .player.active{transform:scale(1.12) rotate(-1.5deg); outline:3px solid var(--accent)}

    .potato{position:absolute; width:62px; height:62px; border-radius:18px; display:grid; place-items:center; background:linear-gradient(135deg, #ffecc6, #ffcf79); color:#6d3f17; font-size:30px; box-shadow:0 12px 24px rgba(0,0,0,.35); transform:translate(-50%,-50%); pointer-events:none}

    /* ‚Äî‚Äî‚Äî Bar de contr√¥le simple ‚Äî‚Äî‚Äî */
    .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center; margin-top:10px}

    /* ‚Äî‚Äî‚Äî Section config ‚Äî‚Äî‚Äî */
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .field{display:flex; align-items:center; gap:8px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.14); padding:8px 10px; border-radius:14px}
    .field input{background:transparent; border:0; outline:0; color:var(--text); width:110px}

    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.16); padding:6px 10px; border-radius:999px; display:inline-flex; align-items:center; gap:8px}
    .chip .rm{background:transparent; border:0; color:#ffd0d0; cursor:pointer; font-weight:700}

    table{width:100%; border-collapse:collapse}
    th,td{text-align:left; padding:10px 8px; border-bottom:1px dashed rgba(255,255,255,.10)}
    th{color:var(--muted); font-weight:700; font-size:14px}

    /* ‚Äî‚Äî‚Äî Effets explosion tropicaux ‚Äî‚Äî‚Äî */
    .flash{position:absolute; inset:0; background:radial-gradient(circle at 50% 50%, rgba(255,255,255,.35) 0%, rgba(255,204,102,.25) 35%, rgba(255,127,110,.20) 60%, rgba(255,255,255,0) 70%); opacity:0; pointer-events:none}
    .flash.on{animation:flash .6s ease}
    @keyframes flash{0%{opacity:1} 100%{opacity:0}}
    .shake{animation:shake .55s ease}
    @keyframes shake{10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(3px, 0, 0);} 30%, 50%, 70% { transform: translate3d(-6px, 0, 0);} 40%, 60% { transform: translate3d(6px, 0, 0);} }
    .grow-red{animation:grow 340ms ease-in forwards}
    @keyframes grow{0%{transform:scale(1); filter:saturate(1)} 80%{transform:scale(1.7); filter:hue-rotate(-25deg) saturate(1.8)} 100%{transform:scale(1.95); filter:hue-rotate(-35deg) saturate(2.1)} }

    .leaf{position:absolute; width:18px; height:36px; background:conic-gradient(from 200deg at 50% 50%, var(--leaf), #089e63); border-radius: 18px 18px 0 18px; opacity:.95}
    .confetti{position:absolute; width:12px; height:18px; border-radius:3px; background: var(--accent2); transform: rotate(0deg);}

    .boom{position:absolute; inset:0; display:grid; place-items:center; pointer-events:none; opacity:0; transition:.25s}
    .boom.active{opacity:1}
    .banner{background:rgba(2,18,20,.92); border:2px solid rgba(255,255,255,.22); padding:16px 22px; border-radius:18px; text-align:center; box-shadow:0 0 0 6px rgba(38,215,174,.18), var(--shadow)}
    .banner h2{margin:0; font-size:40px}
    .banner p{margin:6px 0 0; color:var(--muted)}

    .toast{position:fixed; left:50%; bottom:22px; transform:translateX(-50%); background:#0b2226; border:1px solid rgba(255,255,255,.18); padding:10px 14px; border-radius:12px; color:var(--text); box-shadow:var(--shadow); opacity:0; pointer-events:none; transition:.2s}
    .toast.show{opacity:1}
  </style>
</head>
<body>
  <header>
    <div class="title">
      <div style="font-size:28px">üå¥üçπ</div>
      <h1>Patate Chaude ‚Äì Tropical Fun</h1>
    </div>
    <div class="badge">18+ ‚Ä¢ Buvez avec mod√©ration ‚Ä¢ Mode sans alcool</div>
    <button class="btn ghost" id="reset">R√©initialiser</button>
  </header>

  <div class="container">
    <!-- ======= JEU EN HAUT ======= -->
    <section class="card" aria-labelledby="play-hd" style="margin-top:6px">
      <div class="hd"><strong id="play-hd">Partie</strong><span id="status" class="muted">Pr√™t ?</span></div>
      <div class="bd">
        <div class="arena" id="arena">
          <div class="ring" id="ring"></div>
          <div class="potato" id="potato" aria-hidden="true">ü••</div>
          <div class="flash" id="flash"></div>
          <div class="boom" id="boom" aria-live="assertive" aria-atomic="true">
            <div class="banner">
              <h2 id="boomTitle">üí• BOUM TROPICAL !</h2>
              <p id="boomMsg" class="muted">√áa a explos√© ! Passe au suivant !</p>
            </div>
          </div>
        </div>
        <div class="controls">
          <button class="btn acc" id="start">‚ñ∂ Lancer</button>
          <button class="btn" id="pause" disabled>Pause</button>
          <button class="btn ghost" id="forceStop" disabled>Arr√™t forc√©</button>
        </div>
      </div>
    </section>

    <!-- ======= CONFIG + CLASSEMENT EN BAS ======= -->
    <section class="card" style="margin-top:14px">
      <div class="hd"><strong>R√©glages & Joueurs</strong><span class="muted">Tour <span id="round">0</span></span></div>
      <div class="bd">
        <div class="row">
          <div class="field"><label for="minS">Explosion min</label><input id="minS" type="number" min="2" max="180" step="0.1" value="5"><span class="muted">s</span></div>
          <div class="field"><label for="maxS">Explosion max</label><input id="maxS" type="number" min="3" max="300" step="0.1" value="15"><span class="muted">s</span></div>
          <div class="field"><label for="relayMinS">Relais min</label><input id="relayMinS" type="number" min="0.15" max="5" step="0.05" value="0.35"><span class="muted">s</span></div>
          <div class="field"><label for="relayMaxS">Relais max</label><input id="relayMaxS" type="number" min="0.2" max="8" step="0.05" value="1.4"><span class="muted">s</span></div>
          <div class="field"><label for="volume">Volume</label><input id="volume" type="range" min="0" max="100" value="80"><span class="muted" id="volLabel">80%</span></div>
        </div>
        <div class="row" style="margin-top:8px">
          <label class="field" for="playerName"><input id="playerName" type="text" placeholder="Ajouter un¬∑e joueur¬∑euse"></label>
          <button class="btn" id="addPlayer">Ajouter</button>
        </div>
        <div class="chips" id="players"></div>
      </div>
    </section>

    <section class="card" style="margin-top:14px">
      <div class="hd"><strong>Classement</strong><span class="muted" id="metricLabel">Points</span></div>
      <div class="bd">
        <table>
          <thead><tr><th>Joueur</th><th id="colMetric">Points</th></tr></thead>
          <tbody id="scoreBody"></tbody>
        </table>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="exportCsv">Exporter CSV</button>
          <button class="btn" id="zero">Remise √† z√©ro</button>
        </div>
      </div>
    </section>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">OK</div>

  <script>
    const st = {
      mode:'points', players:[], scores:{}, round:0,
      minS:5, maxS:15, relayMinS:0.35, relayMaxS:1.4, volume:0.8,
      running:false, relayTimer:null, boomTimer:null, idx:0,
      ac:null, master:null
    };

    const $ = s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));

    function save(){ localStorage.setItem('hotPotatoTropical', JSON.stringify(st)); }
    function load(){ try{ const raw = localStorage.getItem('hotPotatoTropical'); if(raw){ Object.assign(st, JSON.parse(raw)); } }catch(e){} }
    function ping(msg){ const t=$('#toast'); t.textContent=msg||'OK'; t.classList.add('show'); setTimeout(()=> t.classList.remove('show'),1100); }

    function addPlayer(name){ name=(name||'').trim(); if(!name) return; if(st.players.includes(name)) {ping('D√©j√† ajout√©'); return;} st.players.push(name); st.scores[name]=st.scores[name]||0; renderPlayers(); renderScores(); layoutRing(); save(); }
    function removePlayer(name){ st.players=st.players.filter(n=>n!==name); delete st.scores[name]; renderPlayers(); renderScores(); layoutRing(); save(); }

    function renderPlayers(){ const wrap=$('#players'); wrap.innerHTML=''; st.players.forEach(n=>{ const el=document.createElement('span'); el.className='chip'; el.innerHTML=`<strong>${escapeHtml(n)}</strong> <button class="rm" title="Supprimer">√ó</button>`; el.querySelector('button').onclick=()=>removePlayer(n); wrap.appendChild(el); }); }
    function renderScores(){ const body=$('#scoreBody'); const rows=Object.entries(st.scores).sort((a,b)=>b[1]-a[1]).map(([n,v])=>`<tr><td><strong>${escapeHtml(n)}</strong></td><td>${v}</td></tr>`).join(''); body.innerHTML=rows; $('#metricLabel').textContent=st.mode==='points'?'Points':'Gorg√©es'; $('#colMetric').textContent=st.mode==='points'?'Points':'Gorg√©es'; $('#round').textContent=st.round; $('#minS').value=st.minS; $('#maxS').value=st.maxS; $('#relayMinS').value=st.relayMinS; $('#relayMaxS').value=st.relayMaxS; $('#volume').value=Math.round(st.volume*100); $('#volLabel').textContent=`${Math.round(st.volume*100)}%`; }

    function layoutRing(){ const ring=$('#ring'); ring.innerHTML=''; const n=st.players.length; if(!n){ $('#status').textContent='Ajoutez des joueurs'; return; }
      const R=50; st.players.forEach((name,i)=>{ const angle=(i/n)*2*Math.PI - Math.PI/2; const x=50+R*Math.cos(angle); const y=50+R*Math.sin(angle); const el=document.createElement('div'); el.className='player'; el.style.left=x+'%'; el.style.top=y+'%'; el.style.transform='translate(-50%,-50%)'; el.dataset.index=i; el.title=name; el.innerHTML=`<span>${escapeHtml(shortName(name))}</span>`; ring.appendChild(el); });
      positionPotatoToIndex(st.idx%Math.max(1,n)); highlightIndex(st.idx%Math.max(1,n));
    }

    function positionPotatoToIndex(i){ const items=$$('#ring .player'); if(!items.length) return; const target=items[i%items.length]; const r = target.getBoundingClientRect(); const parent = $('#ring').getBoundingClientRect(); const x = r.left - parent.left + r.width/2; const y = r.top - parent.top + r.height/2; const p=$('#potato'); p.style.left = x + 'px'; p.style.top = y + 'px'; }
    function highlightIndex(i){ $$('#ring .player').forEach((el,k)=> el.classList.toggle('active', k===i)); }

    // ‚Äî‚Äî‚Äî Audio ‚Äî‚Äî‚Äî
    function getAC(){ if(st.ac) return st.ac; try{ const AC=window.AudioContext||window.webkitAudioContext; st.ac=new AC(); st.master=st.ac.createGain(); st.master.gain.value=st.volume; st.master.connect(st.ac.destination); }catch(e){ st.ac=null } return st.ac; }
    function setVolume(v){ st.volume=v; if(st.master){ st.master.gain.value=v; } }

    function tickSound(){ // clap/tambour tropical plus audible
      try{ const ac=getAC(); if(!ac) return; const o=ac.createOscillator(); const g=ac.createGain(); const bpf=ac.createBiquadFilter();
        o.type='square'; o.frequency.value=560; bpf.type='bandpass'; bpf.frequency.value=1500; bpf.Q.value=0.7; o.connect(bpf); bpf.connect(g); g.connect(st.master||ac.destination);
        g.gain.setValueAtTime(0.001, ac.currentTime);
        g.gain.exponentialRampToValueAtTime(0.75, ac.currentTime+0.01);
        g.gain.exponentialRampToValueAtTime(0.001, ac.currentTime+0.22);
        o.start(); o.stop(ac.currentTime+0.24);
      }catch(e){}
    }

    function boomSound(){ // boom chaud + splash
      try{ const ac=getAC(); if(!ac) return; const g=ac.createGain(); g.gain.value=1.0; g.connect(st.master||ac.destination);
        // bruit blanc (splash confetti)
        const noise=ac.createBufferSource(); const buf=ac.createBuffer(1, ac.sampleRate*0.22, ac.sampleRate); const data=buf.getChannelData(0); for(let i=0;i<data.length;i++){ data[i]=(Math.random()*2-1)*Math.pow(1-i/data.length, 2); } noise.buffer=buf; const nGain=ac.createGain(); nGain.gain.value=0.8; noise.connect(nGain); nGain.connect(g);
        // basse qui descend (boom)
        const o=ac.createOscillator(); o.type='sawtooth'; o.frequency.setValueAtTime(200, ac.currentTime); o.frequency.exponentialRampToValueAtTime(52, ac.currentTime+0.5); const oGain=ac.createGain(); oGain.gain.setValueAtTime(0.0001, ac.currentTime); oGain.gain.exponentialRampToValueAtTime(1.0, ac.currentTime+0.03); oGain.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+0.6); o.connect(oGain); oGain.connect(g);
        noise.start(); o.start(); noise.stop(ac.currentTime+0.25); o.stop(ac.currentTime+0.62);
      }catch(e){}
    }

    // ‚Äî‚Äî‚Äî Flow ‚Äî‚Äî‚Äî
    function ensurePlayers(){ if(st.players.length<2){ ping('Au moins 2 joueurs'); return false } return true; }
    function start(){ if(st.running) return; if(!ensurePlayers()) return;
      // synchro UI -> state
      st.minS = clamp(parseFloat($('#minS').value||st.minS), 2, 600);
      st.maxS = clamp(parseFloat($('#maxS').value||st.maxS), 3, 600); if(st.maxS<=st.minS) st.maxS=st.minS+0.5;
      st.relayMinS = clamp(parseFloat($('#relayMinS').value||st.relayMinS), 0.15, 10);
      st.relayMaxS = clamp(parseFloat($('#relayMaxS').value||st.relayMaxS), 0.20, 12); if(st.relayMaxS<=st.relayMinS) st.relayMaxS=st.relayMinS+0.05;

      st.running=true; $('#status').textContent='Coucou tropicaux‚Ä¶ √ßa tourne !'; $('#start').disabled=true; $('#pause').disabled=false; $('#forceStop').disabled=false;
      const n=st.players.length; st.idx = st.idx % n;
      // timer explosion
      st.boomTimer = setTimeout(stopRound, randf(st.minS, st.maxS)*1000);
      // d√©bloquer audio
      getAC();
      // premier relais
      scheduleRelay();
      save();
    }

    function scheduleRelay(){ if(!st.running) return; const delay = randf(st.relayMinS, st.relayMaxS)*1000;
      st.relayTimer = setTimeout(()=>{
        const n=st.players.length; st.idx=(st.idx+1)%n; highlightIndex(st.idx); positionPotatoToIndex(st.idx); tickSound(); scheduleRelay();
      }, delay);
    }

    function pause(){ if(!st.running) return; clearTimeout(st.relayTimer); clearTimeout(st.boomTimer); st.relayTimer=null; st.boomTimer=null; st.running=false; $('#status').textContent='Pause'; $('#start').disabled=false; $('#pause').disabled=true; $('#forceStop').disabled=true; save(); }

    function stopRound(){ if(!st.running) return; clearTimeout(st.relayTimer); clearTimeout(st.boomTimer); st.relayTimer=null; st.boomTimer=null; st.running=false; $('#start').disabled=false; $('#pause').disabled=true; $('#forceStop').disabled=true;
      const loser = st.players[st.idx]; award(loser, 1); st.round += 1; renderScores(); $('#status').textContent = `${loser} ${st.mode==='points'?'prend 1 point':'boit 1 gorg√©e'}`;
      explode({ originEl: $('#potato'), nomJoueur: loser }); save(); }

    function award(name, val){ st.scores[name]=(st.scores[name]||0)+val; }

    function exportCsv(){ const rows=[["Joueur", st.mode==='points'? 'Points':'Gorg√©es']].concat(Object.entries(st.scores)); const csv=rows.map(r=> r.map(x=>'"'+String(x).replaceAll('"','""')+'"').join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='classement_patate_tropical.csv'; a.click(); URL.revokeObjectURL(url); }

    // ‚Äî‚Äî‚Äî Explosion tropicale ‚Äî‚Äî‚Äî
    async function explode({ originEl, nomJoueur }){
      const arena=$('#arena'); const flash=$('#flash'); const boom=$('#boom'); const t=$('#boomTitle'); const m=$('#boomMsg');
      const r=originEl.getBoundingClientRect(); const a=arena.getBoundingClientRect(); const x=r.left-a.left+r.width/2; const y=r.top-a.top+r.height/2;
      originEl.classList.add('grow-red');
      setTimeout(()=>{ flash.classList.remove('on'); void flash.offsetWidth; flash.classList.add('on'); arena.classList.add('shake'); setTimeout(()=> arena.classList.remove('shake'), 650); }, 160);

      // feuilles + confettis multicolores
      const N=34; for(let i=0;i<N;i++) createLeaf(x,y); for(let i=0;i<26;i++) createConfetti(x,y);
      try{ if(navigator.vibrate) navigator.vibrate([120,90,140]); }catch(e){}
      boomSound();
      t.textContent='üí• BOUM TROPICAL !'; m.textContent = (nomJoueur? nomJoueur+' a explos√© ! ' : '√áa a explos√© ! ') + 'Passe au suivant !';
      boom.classList.add('active'); await wait(850); originEl.classList.remove('grow-red'); await wait(700); boom.classList.remove('active');
    }

    function createLeaf(x,y){ const el=document.createElement('div'); el.className='leaf'; el.style.left=x+'px'; el.style.top=y+'px'; $('#arena').appendChild(el);
      const ang=Math.random()*Math.PI*2; const dist=100+Math.random()*240; const dx=Math.cos(ang)*dist; const dy=Math.sin(ang)*dist; const rot=(Math.random()*180-90)|0; const scale=.7+Math.random()*1.1;
      el.animate([{ transform:`translate(0,0) rotate(0deg) scale(1)`, opacity:1 },{ transform:`translate(${dx}px, ${dy}px) rotate(${rot}deg) scale(${scale})`, opacity:0 }], { duration: 900+Math.random()*420, easing:'cubic-bezier(.2,.7,.1,1)', fill:'forwards'}).finished.then(()=> el.remove());
    }

    function createConfetti(x,y){ const el=document.createElement('div'); el.className='confetti'; el.style.left=x+'px'; el.style.top=y+'px'; el.style.background = [ 'var(--accent2)', 'var(--accent)', 'var(--accent3)' ][Math.floor(Math.random()*3)]; $('#arena').appendChild(el);
      const ang=Math.random()*Math.PI*2; const dist=80+Math.random()*220; const dx=Math.cos(ang)*dist; const dy=Math.sin(ang)*dist; const rot=(Math.random()*540-270)|0; const scale=.7+Math.random();
      el.animate([{ transform:`translate(0,0) rotate(0deg) scale(1)`, opacity:1 },{ transform:`translate(${dx}px, ${dy}px) rotate(${rot}deg) scale(${scale})`, opacity:0 }], { duration: 820+Math.random()*360, easing:'cubic-bezier(.2,.7,.1,1)', fill:'forwards'}).finished.then(()=> el.remove());
    }

    // ‚Äî‚Äî‚Äî Utils ‚Äî‚Äî‚Äî
    const wait = ms => new Promise(r=> setTimeout(r, ms));
    const randf=(a,b)=> a + Math.random()*(b-a);
    const clamp=(v,lo,hi)=> Math.max(lo, Math.min(hi, Number.isFinite(v)? v: lo));
    function shortName(n){ return n.length<=8? n : n.slice(0,7)+'‚Ä¶'; }
    function escapeHtml(s){ return String(s).replace(/[&<>\"]/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }

    // ‚Äî‚Äî‚Äî Events ‚Äî‚Äî‚Äî
    $('#addPlayer').onclick = ()=> { addPlayer($('#playerName').value); $('#playerName').value=''; $('#playerName').focus(); };
    $('#playerName').addEventListener('keydown', e=> { if(e.key==='Enter'){ $('#addPlayer').click(); } });
    $('#start').onclick = start; $('#pause').onclick = pause; $('#forceStop').onclick = stopRound; $('#reset').onclick = resetAll;
    $('#minS').onchange = e=> { st.minS = clamp(parseFloat(e.target.value), 2, 600); save(); };
    $('#maxS').onchange = e=> { st.maxS = clamp(parseFloat(e.target.value), 3, 600); save(); };
    $('#relayMinS').onchange = e=> { st.relayMinS = clamp(parseFloat(e.target.value), 0.15, 12); save(); };
    $('#relayMaxS').onchange = e=> { st.relayMaxS = clamp(parseFloat(e.target.value), 0.20, 12); save(); };
    $('#volume').oninput = e=> { const v=(e.target.value|0)/100; setVolume(v); $('#volLabel').textContent = `${Math.round(v*100)}%`; save(); };

    function pause(){ if(!st.running) return; clearTimeout(st.relayTimer); clearTimeout(st.boomTimer); st.running=false; $('#start').disabled=false; $('#pause').disabled=true; $('#forceStop').disabled=true; $('#status').textContent='Pause'; save(); }
    function resetAll(){ if(!confirm('R√©initialiser la partie ?')) return; pause(); st.players=[]; st.scores={}; st.round=0; st.idx=0; renderPlayers(); renderScores(); layoutRing(); $('#status').textContent='Pr√™t ?'; save(); }

    function scheduleRelay(){ if(!st.running) return; const delay = randf(st.relayMinS, st.relayMaxS)*1000; st.relayTimer = setTimeout(()=>{ const n=st.players.length; st.idx=(st.idx+1)%n; highlightIndex(st.idx); positionPotatoToIndex(st.idx); tickSound(); scheduleRelay(); }, delay); }
    function stopRound(){ if(!st.running) return; clearTimeout(st.relayTimer); clearTimeout(st.boomTimer); st.running=false; $('#start').disabled=false; $('#pause').disabled=true; $('#forceStop').disabled=true; const loser=st.players[st.idx]; award(loser,1); st.round+=1; renderScores(); $('#status').textContent = `${loser} ${st.mode==='points'?'prend 1 point':'boit 1 gorg√©e'}`; explode({ originEl: $('#potato'), nomJoueur: loser }); save(); }

    function exportCsv(){ const rows=[["Joueur", st.mode==='points'? 'Points':'Gorg√©es']].concat(Object.entries(st.scores)); const csv=rows.map(r=> r.map(x=>'"'+String(x).replaceAll('"','""')+'"').join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='classement_tropical.csv'; a.click(); URL.revokeObjectURL(url); }

    // ‚Äî‚Äî‚Äî Init ‚Äî‚Äî‚Äî
    load(); renderPlayers(); renderScores(); layoutRing(); setVolume(st.volume);
  </script>
</body>
</html>

