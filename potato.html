<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Patate Chaude – Relais irréguliers + Explosion</title>
  <meta name="description" content="Hot Potato avec délais de relais aléatoires et explosion finale entre un temps min et max. HTML/CSS/JS autonome.">
  <style>
    :root{
      --bg:#0f1020; --panel:#161936; --panel2:#1c1f48; --text:#e8ecff; --muted:#a7b0d9;
      --accent:#8ab4ff; --accent2:#7df9c9; --danger:#ff7b9c; --ok:#79e0a8; --radius:18px;
      --shadow:0 12px 28px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:radial-gradient(1100px 700px at 10% 0%, #17193a 0%, #0f1020 60%, #0c0d19 100%);
      color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial}
    .container{max-width:1200px; margin:24px auto; padding:16px}
    header{display:grid; grid-template-columns:1fr auto; gap:12px; align-items:end}
    h1{margin:0; font-size:clamp(24px,3vw,40px)}
    .badge{display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; background:linear-gradient(135deg,var(--panel),var(--panel2)); color:var(--muted); box-shadow:var(--shadow); font-size:12px}

    .grid{display:grid; gap:16px; grid-template-columns:1.15fr .85fr}
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr } }

    .card{background:linear-gradient(135deg,var(--panel),var(--panel2)); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden}
    .card .hd{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.08); color:var(--muted)}
    .card .bd{padding:16px}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .field{display:flex; align-items:center; gap:8px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.10); padding:8px 10px; border-radius:12px}
    .field input{background:transparent; border:0; outline:0; color:var(--text)}
    input[type="number"]{width:90px}

    .btn{--bg:#202457; background:var(--bg); color:var(--text); border:1px solid rgba(255,255,255,.12); padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:700; box-shadow:var(--shadow); transition:.15s transform ease}
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.acc{--bg:linear-gradient(135deg,var(--accent),var(--accent2)); color:#091224; border:0}
    .btn.ghost{background:transparent; border:1px dashed rgba(255,255,255,.25)}
    .btn.danger{--bg:#3b1630; color:#ffd0e3; border-color:#5a2547}

    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1); padding:6px 10px; border-radius:999px; display:inline-flex; align-items:center; gap:8px}
    .chip .rm{background:transparent; border:0; color:#ffd0d0; cursor:pointer; font-weight:700}

    .mode-toggle{display:flex; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.10); padding:4px; border-radius:12px}
    .mode-toggle button{flex:1; padding:10px 12px; border-radius:10px; border:0; cursor:pointer; color:var(--muted); background:transparent; font-weight:700}
    .mode-toggle button.active{background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#0b0e1e}

    table{width:100%; border-collapse:collapse}
    th,td{text-align:left; padding:10px 8px; border-bottom:1px dashed rgba(255,255,255,.08)}
    th{color:var(--muted); font-weight:600; font-size:14px}

    /* ——— Ring ——— */
    .arena{position:relative; width:100%; aspect-ratio:1/1; min-height:360px; display:grid; place-items:center}
    .ring{position:relative; width:min(90%,560px); aspect-ratio:1/1; border-radius:999px; background:radial-gradient(220px 220px at 50% 50%, rgba(255,255,255,.02), rgba(255,255,255,0)); box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)}
    .player{position:absolute; width:76px; height:76px; border-radius:999px; display:grid; place-items:center; background:#12153a; border:1px solid rgba(255,255,255,.1); box-shadow:var(--shadow); transition:.12s transform ease, .12s box-shadow ease, .2s outline ease}
    .player span{font-weight:800; font-size:14px; padding:0 8px; text-align:center}
    .player.active{transform:scale(1.15); outline:2px solid var(--accent); z-index:3}

    .potato{position:absolute; width:54px; height:54px; border-radius:999px; display:grid; place-items:center; background:linear-gradient(135deg,#f8d9a1,#e8b66e); color:#7a4b1a; box-shadow:0 12px 24px rgba(0,0,0,.35); font-size:28px; transform:translate(-50%,-50%); pointer-events:none}
    .spin{animation:spin 0.9s linear infinite}
    @keyframes spin{from{transform:translate(-50%,-50%) rotate(0deg)} to{transform:translate(-50%,-50%) rotate(360deg)}}

    .muted{color:var(--muted)}
    .footer{margin-top:12px; color:var(--muted); font-size:12px}
    .toast{position:fixed; left:50%; bottom:22px; transform:translateX(-50%); background:#0f1230; border:1px solid rgba(255,255,255,.15); padding:10px 14px; border-radius:10px; color:var(--text); box-shadow:var(--shadow); opacity:0; pointer-events:none; transition:.2s}
    .toast.show{opacity:1}

    /* —— Effets Explosion —— */
    .boom{position:absolute; inset:0; display:grid; place-items:center; pointer-events:none; opacity:0; transition:.25s}
    .boom.active{opacity:1}
    .boom .banner{background:rgba(6,8,24,.85); border:1px solid rgba(255,255,255,.15); padding:18px 22px; border-radius:16px; box-shadow:var(--shadow); text-align:center}
    .boom .banner h2{margin:0; font-size:34px}
    .boom .banner p{margin:6px 0 0; color:var(--muted)}
    .particle{position:absolute; width:14px; height:14px; border-radius:999px; background:radial-gradient(circle at 30% 30%, #ffd27a 0%, #f39b2f 60%, #c86c1c 100%); will-change: transform, opacity}
    .flash{position:absolute; inset:0; background:radial-gradient(circle, rgba(255,255,255,.28) 0%, rgba(255,255,255,0) 60%); opacity:0; pointer-events:none}
    .flash.on{animation:flash .45s ease}
    @keyframes flash{0%{opacity:.9} 100%{opacity:0}}
    .shake{animation:shake .4s ease}
    @keyframes shake{10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0);} 30%, 50%, 70% { transform: translate3d(-4px, 0, 0);} 40%, 60% { transform: translate3d(4px, 0, 0);} }
    .grow-red{animation:grow 280ms ease-in forwards}
    @keyframes grow{0%{transform:scale(1); filter:saturate(1)} 80%{transform:scale(1.55); filter:hue-rotate(-25deg) saturate(1.6)} 100%{transform:scale(1.7); filter:hue-rotate(-35deg) saturate(1.9)} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Patate Chaude <span class="muted">– Relais irréguliers + Explosion</span></h1>
        <p class="badge">18+ · Buvez avec modération · <strong>Mode sans alcool</strong> dispo</p>
      </div>
      <div class="row">
        <button class="btn ghost" id="reset">Réinitialiser</button>
      </div>
    </header>

    <div class="grid">
      <section class="card" aria-labelledby="cfg-hd">
        <div class="hd"><strong id="cfg-hd">Paramètres & Joueurs</strong><span class="muted">Tour <span id="round">0</span></span></div>
        <div class="bd">
          <div class="row">
            <div class="mode-toggle" id="modeToggle" role="tablist" aria-label="Basculer le mode">
              <button role="tab" aria-selected="true" class="active" data-mode="points">Mode points</button>
              <button role="tab" aria-selected="false" data-mode="sips">Mode gorgées</button>
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <div class="field"><label for="minS">Explosion min</label><input id="minS" type="number" min="2" max="60" value="5" aria-label="Durée minimale (secondes)"><span class="muted">s</span></div>
            <div class="field"><label for="maxS">Explosion max</label><input id="maxS" type="number" min="3" max="120" value="15" aria-label="Durée maximale (secondes)"><span class="muted">s</span></div>
          </div>
          <div class="row">
            <div class="field"><label for="relayMin">Relais min</label><input id="relayMin" type="number" min="120" max="3000" value="300" aria-label="Délai minimum entre bips (ms)"><span class="muted">ms</span></div>
            <div class="field"><label for="relayMax">Relais max</label><input id="relayMax" type="number" min="200" max="4000" value="1200" aria-label="Délai maximum entre bips (ms)"><span class="muted">ms</span></div>
          </div>
          <div class="row" style="margin-top:8px">
            <label class="field" for="playerName"><input id="playerName" type="text" placeholder="Ajouter un·e joueur·euse" aria-label="Nom du joueur"></label>
            <button class="btn" id="addPlayer">Ajouter</button>
          </div>
          <div class="chips" id="players"></div>
        </div>
      </section>

      <section class="card" aria-labelledby="score-hd">
        <div class="hd"><strong id="score-hd">Classement</strong><span class="muted" id="metricLabel">Points</span></div>
        <div class="bd">
          <table>
            <thead><tr><th>Joueur</th><th id="colMetric">Points</th></tr></thead>
            <tbody id="scoreBody"></tbody>
          </table>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="exportCsv">Exporter CSV</button>
            <button class="btn" id="zero">Remise à zéro</button>
          </div>
        </div>
      </section>
    </div>

    <section class="card" aria-labelledby="play-hd" style="margin-top:16px">
      <div class="hd"><strong id="play-hd">Partie</strong><span class="muted" id="status">Prêt ?</span></div>
      <div class="bd">
        <div class="arena" id="arena">
          <div class="ring" id="ring"></div>
          <div class="potato spin" id="potato" aria-hidden="true">🥔</div>
          <div class="flash" id="flash"></div>
          <div class="boom" id="boom" aria-live="assertive" aria-atomic="true">
            <div class="banner">
              <h2 id="boomTitle">💥 BOUM !</h2>
              <p id="boomMsg" class="muted">La patate a explosé !</p>
            </div>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn acc" id="start">▶ Lancer</button>
          <button class="btn" id="pause" disabled>Pause</button>
          <button class="btn ghost" id="forceStop" disabled>Arrêt forcé</button>
        </div>
      </div>
    </section>

    <p class="footer">⚠️ Jeu réservé aux personnes majeures. Hydratez-vous régulièrement. En <strong>mode points</strong>, remplacez une gorgée par 1 point (jeu 100% sans alcool possible).</p>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">OK</div>

  <script>
    const st = {
      mode:'points', players:[], scores:{}, round:0,
      minS:5, maxS:15, relayMin:300, relayMax:1200,
      running:false, relayTimer:null, boomTimer:null, idx:0,
      ac:null
    };
    const $ = s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));

    function save(){ localStorage.setItem('hotPotatoIrregularFR', JSON.stringify(st)); }
    function load(){ try{ const raw = localStorage.getItem('hotPotatoIrregularFR'); if(raw){ Object.assign(st, JSON.parse(raw)); } }catch(e){} }
    function ping(msg){ const t=$('#toast'); t.textContent=msg||'OK'; t.classList.add('show'); setTimeout(()=> t.classList.remove('show'),1100); }

    function addPlayer(name){ name=(name||'').trim(); if(!name) return; if(st.players.includes(name)) {ping('Déjà ajouté'); return;} st.players.push(name); st.scores[name]=st.scores[name]||0; renderPlayers(); renderScores(); layoutRing(); save(); }
    function removePlayer(name){ st.players=st.players.filter(n=>n!==name); delete st.scores[name]; renderPlayers(); renderScores(); layoutRing(); save(); }

    function renderPlayers(){ const wrap=$('#players'); wrap.innerHTML=''; st.players.forEach(n=>{ const el=document.createElement('span'); el.className='chip'; el.innerHTML=`<strong>${escapeHtml(n)}</strong> <button class="rm" title="Supprimer">×</button>`; el.querySelector('button').onclick=()=>removePlayer(n); wrap.appendChild(el); }); }
    function renderScores(){ const body=$('#scoreBody'); const rows=Object.entries(st.scores).sort((a,b)=>b[1]-a[1]).map(([n,v])=>`<tr><td><strong>${escapeHtml(n)}</strong></td><td>${v}</td></tr>`).join(''); body.innerHTML=rows; $('#metricLabel').textContent=st.mode==='points'?'Points':'Gorgées'; $('#colMetric').textContent=st.mode==='points'?'Points':'Gorgées'; $('#round').textContent=st.round; $('#minS').value=st.minS; $('#maxS').value=st.maxS; $('#relayMin').value=st.relayMin; $('#relayMax').value=st.relayMax; $$('#modeToggle button').forEach(btn=>btn.classList.toggle('active', btn.dataset.mode===st.mode)); }

    function updateMode(m){ st.mode=m; renderScores(); save(); }

    function layoutRing(){ const ring=$('#ring'); ring.innerHTML=''; const n=st.players.length; if(!n){ $('#status').textContent='Ajoutez des joueurs'; return; }
      const R=50; // radius %
      st.players.forEach((name,i)=>{ const angle= (i/n)*2*Math.PI - Math.PI/2; const x=50+R*Math.cos(angle); const y=50+R*Math.sin(angle); const el=document.createElement('div'); el.className='player'; el.style.left=x+'%'; el.style.top=y+'%'; el.style.transform='translate(-50%,-50%)'; el.dataset.index=i; el.title=name; el.innerHTML=`<span>${escapeHtml(shortName(name))}</span>`; ring.appendChild(el); });
      positionPotatoToIndex(st.idx%Math.max(1,n)); highlightIndex(st.idx%Math.max(1,n));
    }

    function positionPotatoToIndex(i){ const items=$$('#ring .player'); if(!items.length) return; const target=items[i%items.length]; const r = target.getBoundingClientRect(); const parent = $('#ring').getBoundingClientRect(); const x = r.left - parent.left + r.width/2; const y = r.top - parent.top + r.height/2; const p=$('#potato'); p.style.left = x + 'px'; p.style.top = y + 'px'; }
    function highlightIndex(i){ $$('#ring .player').forEach((el,k)=> el.classList.toggle('active', k===i)); }

    function ensurePlayers(){ if(st.players.length<2){ ping('Au moins 2 joueurs'); return false } return true; }

    function getAC(){ if(st.ac) return st.ac; try{ const AC=window.AudioContext||window.webkitAudioContext; st.ac=new AC(); }catch(e){ st.ac=null } return st.ac; }

    function beepTick(){
      try{
        const ac=getAC(); if(!ac) return; const o=ac.createOscillator(); const g=ac.createGain();
        o.type='square'; o.frequency.setValueAtTime(900, ac.currentTime); // tick aigu
        g.gain.setValueAtTime(0.0001, ac.currentTime);
        g.gain.exponentialRampToValueAtTime(0.25, ac.currentTime+0.005);
        g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+0.07);
        o.connect(g); g.connect(ac.destination); o.start(); o.stop(ac.currentTime+0.08);
      }catch(e){}
    }

    function start(){ if(st.running) return; if(!ensurePlayers()) return;
      // validation
      st.minS = clampNum(parseInt($('#minS').value||st.minS,10), 2, 120);
      st.maxS = clampNum(parseInt($('#maxS').value||st.maxS,10), 3, 300);
      if(st.maxS <= st.minS) st.maxS = st.minS + 1;
      st.relayMin = clampNum(parseInt($('#relayMin').value||st.relayMin,10), 120, 4000);
      st.relayMax = clampNum(parseInt($('#relayMax').value||st.relayMax,10), 200, 5000);
      if(st.relayMax <= st.relayMin) st.relayMax = st.relayMin + 50;

      st.running=true; $('#status').textContent='Ça tourne… (relais irréguliers)'; $('#start').disabled=true; $('#pause').disabled=false; $('#forceStop').disabled=false;
      const n=st.players.length; st.idx = st.idx % n;

      // Durée aléatoire avant explosion
      const boomDelay = randomInt(st.minS*1000, st.maxS*1000);
      st.boomTimer = setTimeout(stopRound, boomDelay);

      // Débloque l'audio sur interaction
      getAC();

      // Planifie le premier relais
      scheduleNextRelay();
      save();
    }

    function scheduleNextRelay(){ if(!st.running) return; const delay = randomInt(st.relayMin, st.relayMax);
      st.relayTimer = setTimeout(()=>{
        const n=st.players.length; st.idx=(st.idx+1)%n; highlightIndex(st.idx); positionPotatoToIndex(st.idx); beepTick(); scheduleNextRelay();
      }, delay);
    }

    function pause(){ if(!st.running) return; clearTimeout(st.relayTimer); clearTimeout(st.boomTimer); st.relayTimer=null; st.boomTimer=null; st.running=false; $('#status').textContent='Pause'; $('#start').disabled=false; $('#pause').disabled=true; $('#forceStop').disabled=true; save(); }

    function stopRound(){ if(!st.running) return; clearTimeout(st.relayTimer); clearTimeout(st.boomTimer); st.relayTimer=null; st.boomTimer=null; st.running=false; $('#start').disabled=false; $('#pause').disabled=true; $('#forceStop').disabled=true;
      const loser = st.players[st.idx]; award(loser, 1); st.round += 1; renderScores(); $('#status').textContent = `${loser} ${st.mode==='points'?'prend 1 point':'boit 1 gorgée'}`;
      // Effet explosion
      const potatoEl = $('#potato'); explosionPatate({ originEl: potatoEl, nomJoueur: loser }); save(); }

    function award(name, val){ st.scores[name]=(st.scores[name]||0)+val; }

    function exportCsv(){ const rows=[["Joueur", st.mode==='points'? 'Points':'Gorgées']].concat(Object.entries(st.scores)); const csv=rows.map(r=> r.map(x=>'"'+String(x).replaceAll('"','""')+'"').join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='classement_patate_chaude.csv'; a.click(); URL.revokeObjectURL(url); }

    function zero(){ Object.keys(st.scores).forEach(k=>st.scores[k]=0); st.round=0; renderScores(); save(); }
    function resetAll(){ if(!confirm('Réinitialiser la partie ?')) return; pause(); st.players=[]; st.scores={}; st.round=0; st.idx=0; renderPlayers(); renderScores(); layoutRing(); $('#status').textContent='Prêt ?'; save(); }

    // utils
    function shortName(n){ if(n.length<=8) return n; return n.slice(0,7)+'…'; }
    function escapeHtml(s){ return String(s).replace(/[&<>\"]/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
    function randomInt(min,max){ return Math.floor(min + Math.random()*(max-min)); }
    function clampNum(v,lo,hi){ return Math.max(lo, Math.min(hi, v||lo)); }

    // —— Effet explosion réutilisable ——
    async function explosionPatate({ originEl, nomJoueur }){
      const arena = $('#arena'); const flash = $('#flash'); const boom = $('#boom'); const boomTitle = $('#boomTitle'); const boomMsg = $('#boomMsg');
      // center
      const r = originEl.getBoundingClientRect(); const a = arena.getBoundingClientRect(); const x = r.left - a.left + r.width/2; const y = r.top - a.top + r.height/2;
      // pré-anim
      originEl.classList.add('grow-red');
      // flash + shake
      setTimeout(()=>{ flash.classList.remove('on'); void flash.offsetWidth; flash.classList.add('on'); arena.classList.add('shake'); setTimeout(()=> arena.classList.remove('shake'), 420); }, 140);
      // particules
      const N = 28; for(let i=0;i<N;i++){ const p = document.createElement('div'); p.className='particle'; p.style.left=x+'px'; p.style.top=y+'px'; arena.appendChild(p); animateParticle(p); }
      // vibration
      try{ if(navigator.vibrate){ navigator.vibrate([60,40,60]); } }catch(e){}
      // son
      boomSound();
      // overlay
      boomTitle.textContent = '💥 BOUM !'; boomMsg.textContent = nomJoueur ? `${nomJoueur} a explosé avec la patate !` : 'La patate a explosé !'; boom.classList.add('active');
      // cleanup
      await wait(650); originEl.classList.remove('grow-red'); await wait(600); boom.classList.remove('active');
    }

    function animateParticle(el){
      const angle = Math.random()*Math.PI*2; const dist = 80 + Math.random()*180; const dx = Math.cos(angle)*dist; const dy = Math.sin(angle)*dist; const rot = (Math.random()*720-360)|0; const scale = 0.8 + Math.random()*0.8;
      el.animate([{ transform:`translate(0,0) scale(1) rotate(0deg)`, opacity:1 }, { transform:`translate(${dx}px, ${dy}px) scale(${scale}) rotate(${rot}deg)`, opacity:0 }], { duration: 720 + Math.random()*280, easing:'cubic-bezier(.2,.7,.1,1)', fill:'forwards' }).finished.then(()=> el.remove());
    }

    function boomSound(){
      try{ const ac=getAC(); if(!ac) return; const o=ac.createOscillator(); const g=ac.createGain(); const n=ac.createBufferSource(); const buf = ac.createBuffer(1, ac.sampleRate*0.12, ac.sampleRate); const data = buf.getChannelData(0); for(let i=0;i<data.length;i++){ data[i] = (Math.random()*2-1)*Math.pow(1-i/data.length, 2); } n.buffer = buf; o.type='sawtooth'; o.frequency.setValueAtTime(180, ac.currentTime); o.frequency.exponentialRampToValueAtTime(60, ac.currentTime+0.25); g.gain.setValueAtTime(0.0001, ac.currentTime); g.gain.exponentialRampToValueAtTime(0.4, ac.currentTime+0.02); g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+0.35); o.connect(g); n.connect(g); g.connect(ac.destination); o.start(); n.start(); o.stop(ac.currentTime+0.36); }catch(e){}
    }

    const wait = ms => new Promise(r=> setTimeout(r, ms));

    // events
    $('#addPlayer').onclick = ()=> { addPlayer($('#playerName').value); $('#playerName').value=''; $('#playerName').focus(); };
    $('#playerName').addEventListener('keydown', e=> { if(e.key==='Enter'){ $('#addPlayer').click(); } });
    $$('#modeToggle button').forEach(btn=> btn.onclick = ()=> updateMode(btn.dataset.mode));
    $('#start').onclick = start; $('#pause').onclick = pause; $('#forceStop').onclick = stopRound;
    $('#exportCsv').onclick = exportCsv; $('#zero').onclick = zero; $('#reset').onclick = resetAll;
    $('#minS').onchange = e=> { st.minS = clampNum(parseInt(e.target.value||5,10), 2, 300); save(); };
    $('#maxS').onchange = e=> { st.maxS = clampNum(parseInt(e.target.value||15,10), 3, 600); save(); };
    $('#relayMin').onchange = e=> { st.relayMin = clampNum(parseInt(e.target.value||300,10), 120, 5000); save(); };
    $('#relayMax').onchange = e=> { st.relayMax = clampNum(parseInt(e.target.value||1200,10), 200, 6000); save(); };

    // init
    load(); renderPlayers(); renderScores(); layoutRing();
  </script>
</body>
</html>
